<html lang="en" ng-app="musicViz">
    <head>
      <meta charset="UTF-8">
      <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=no">
      <meta http-equiv="X-UA-Compatible" content="IE=edge" >

      <title>Web Audio</title>
      <!-- script -->
      <script src="libs/three.min.js" defer></script>
      <script src="libs/angularjs-1.3.14-angular.min.js" defer></script>
      <script src="js/app.js" defer></script>
      <script src="js/controller.js" defer></script>
      <script src="js/soundcloud_service.js" defer></script>
      <script src="js/audio_service.js" defer></script>
      <script src="js/graphics.js" defer></script>
      <script src="js/filters.js" defer></script>
      <script src="https://connect.soundcloud.com/sdk/sdk-3.0.0.js"></script>


      <!-- style -->
      <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
      <link href='https://fonts.googleapis.com/css?family=Roboto+Mono' rel='stylesheet' type='text/css'>
      <link rel="stylesheet" type="text/css" href="css/style.css">
      
    </head>
    <body ng-controller="musicVizController as ctrl">

      <nav class="navbar navbar-inverse navbar-fixed-top">
        <form class="navbar-form navbar-left" role="search">
          <div class="form-group">
            <!-- TODO: replace with SoundCloud logo -->
            <label for="search-soundcloud">Search SoundCloud</label> 
            <input ng-model="ctrl.searchQuery" type="text" class="form-control" id="search-soundcloud" placeholder="Kanye West">
          </div>
        </form>
        <button ng-click="ctrl.pauseTrack()" class="btn btn-default">Pause</button>
        <button ng-click="ctrl.playTrack()" class="btn btn-default">Play</button>
      </nav>
      <div class="static">
        <ul class="list-group">
          <!-- TODO: add filter for longer names -->
          <li ng-class="{'list-group-item':true, 'active':hovering}" 
              ng-mouseenter="hovering=true"
              ng-mouseleave="hovering=false"
              ng-repeat="result in ctrl.searchResults | streamable">

              {{ result.title }}
              <div class="pull-right">
                <button ng-click="ctrl.selectTrack(result)" class="btn btn-small btn-default"><span class="glyphicon glyphicon-play"></span></button>
                <button ng-click="ctrl.addToTrackQueue(result)" class="btn btn-small btn-default"><span class="glyphicon glyphicon-plus"></span></button>
              </div>
          </li>
          <p ng-repeat="track in ctrl.trackQueue" style="color: white;">{{ track.stream_url }}</p>

        </ul>
      </div>
<!-- <audio id="player" controls autoplay preload autobuffer crossorigin="anonymous" src="https://api.soundcloud.com/tracks/52010243/stream?client_id=5a890217b642c08738865e3687299be3"></audio> -->
      <!-- <audio id="player"></audio> -->
      <script type="text/javascript">
        // SC.initialize({
        //   client_id: '5a890217b642c08738865e3687299be3',
        //   redirect_url: 'http://127.0.0.1:8080/'
        // });
        // TODO: test if soundcloud sdk has the same CORS issue
        // SC.stream('/tracks/123063109').then(function(player){
        //   console.log('playing song with SC SDK', player);          
        // });
        
        // var player = document.getElementById('player');
        // var analyser;
        // var audioCtx = new AudioContext(); // this is because it's not been standardised accross browsers yet.
        // console.log('created AudioContext');
        // analyser = audioCtx.createAnalyser();
        // console.log('created analyser');
        // analyser.fftSize = 256; // see - there is that 'fft' thing. 
        // var source = audioCtx.createMediaElementSource(player); // this is where we hook up the <audio> element
        // console.log('created source');
        // source.connect(analyser);
        // analyser.connect(audioCtx.destination);


        // console.log('linked', player);
        // player.setAttribute('src', 'https://api.soundcloud.com/tracks/123063109/stream?client_id=5a890217b642c08738865e3687299be3');
        // player.load();
        // player.play();
        var audio = new Audio();
        audio.src = 'https://api.soundcloud.com/tracks/52010243/stream?client_id=5a890217b642c08738865e3687299be3';
        audio.controls = true;
        audio.autoplay = true;
        audio.crossOrigin = "anonymous";
        document.body.appendChild(audio);

        var context = new (window.AudioContext || window.webkitAudioContext)();

        window.addEventListener('load', function(e) {

          analyser = context.createAnalyser();
          console.log('created analyser');
          analyser.fftSize = 256; // see - there is that 'fft' thing. 
          var source = context.createMediaElementSource(audio);
          console.log('created source');
          source.connect(analyser);
          analyser.connect(context.destination);

          var data = new Uint8Array(256);
          // analyser.getByteFrequencyData(data);

          console.log(context, source);
          function getDataLoop() {
            setTimeout(function() {
              analyser.getByteFrequencyData(data);
              console.log(data);
              getDataLoop();
            }, 100);
          }
        }, false);

       
      </script>

    </body>
</html>